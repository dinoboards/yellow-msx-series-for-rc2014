
; Code to write each memory segment onto the ROM banks

; then reboot!

; Erase a ROM SEGMENT!

PSL_STAT:       EQU     $A8             ; slot status
SEGS:		EQU	$C000

; ROM ERASE-SECTOR WRITE PROCEDURE:
; 1. WRITE TO 5555H AAH 
; 2. WRITE TO 02AAA 55H
; 3. WRITE TO 5555H 80H 
; 4. WRITE TO 5555H AAH 
; 5. WRITE TO 2AAAH 55H 
; 6. WRITE TO <sector> 30H 
	ORG	$C100

	LD	SP, $F000
LOOP:
	CALL	ERASE_EXTENDED_ROM

	ld b,b
	jr $+2

	; LOOP:
	; SWITCH IN ALLOCATD SEGMENT L
	; COPY FROM 8000 TO WORKING_BUF, FOR $1000 BYTES
	; SWITCH BACK IN ROM BANK
	; PROGRAM FROM 8000 TO 8FFF
	
	; LOOP FOR 8000, 9000, A000 AND B000

	EXX
	; SWITCH IN BANK L

	; SWITCH PAGE 2 TO RAM SLOT (SLOT 3-2)
	LD	A, (0FFFFH)		; SELECT SUB SLOT 3 FOR PAGE 2
	CPL	
	AND	11001111B
	OR	00100000B		; MASK IN 2 FOR PAGE 2 (RAM)
	LD	(0FFFFH), A

	LD	A, (SEGS)
	OUT	($FE), A		; SELECT SOURCE BANK

	LD	HL, $8000
	LD	DE, WORKING_BUF
	LD	BC, $1000
	LDIR

	; SWITCH PAGE 2 TO ROM SLOT (SLOT 3-3)
	LD	A, (0FFFFH)		; SELECT SUB SLOT 3 FOR PAGE 2
	CPL	
	OR	00110000B		; MASK IN 3 FOR PAGE 2 (ROM)
	LD	(0FFFFH), A


	; FLASH THE FIRST 4K
	LD	HL, $8000
	LD	DE, WORKING_BUF
	LD	BC, $1000
	
PRG_NXT_BYTE:
	CALL	PRG_EXTENDED_ROM

	INC	HL
	INC	DE
	DEC	BC
	LD	A, B
	OR	C
	JR	NZ, PRG_NXT_BYTE

	HALT

ERASE_SECTOR_PREFIX:
	LD	A, 0AAH			; WRITES AA to 05555 (ROM)
	LD	(05555H), A

	LD	A, 055H			; WRITES 55 to 02AAA (ROM)
	LD	(02AAAH), A

	LD	A, 080H			; WRITES 80 to 05555 (ROM)
	LD	(05555H), A

	LD	A, 0AAH			; WRITES AA to 05555 (ROM)
	LD	(05555H), A

	LD	A, 055H			; WRITES 55 to 02AAA (ROM)
	LD	(02AAAH), A
	RET

ERASE_EXTENDED_ROM:
	IN	A, (PSL_STAT)		; SELECT SLOT 0 FOR PAGE 0 AND PAGE 1
	AND	011110000B
	OUT	(PSL_STAT), A

	IN	A, (PSL_STAT)		; SELECT SLOT 3 FOR PAGE 2
	OR	00110000B
	OUT	(PSL_STAT), A

	LD	A, (0FFFFH)		; SELECT SUB SLOT 3 FOR PAGE 2
	CPL	
	OR	00110000B		; MASK IN 3 FOR PAGE 2
	LD	(0FFFFH), A

	LD	HL, $8000
	LD	DE, $1000
	LD	B, 4

ERASE_NEXT_SECTOR:
	CALL	ERASE_SECTOR_PREFIX
	LD	A, 030H			; WRITE 30 TO FF000 (ROM)
	LD	(HL), A

WAIT_FOR_ERASE:
	LD	A, (HL)
	CP	(HL)
	JR	NZ, WAIT_FOR_ERASE

	ADD	Hl, DE
	DJNZ	ERASE_NEXT_SECTOR

	RET

PRG_EXTENDED_ROM:
	LD	A, 0AAH			; WRITES AA to 05555 (ROM)
	LD	(05555H), A

	LD	A, 055H			; WRITES 55 to 02AAA (ROM)
	LD	(02AAAH), A

	LD	A, 0A0H			; WRITES AA to 05555 (ROM)
	LD	(05555H), A

	LD	A, (DE)
	LD	(HL), A

WAIT_FOR_PRG:
	LD	A, (HL)
	CP	(HL)
	JR	NZ, WAIT_FOR_PRG

	RET

; HL IS SOURCE ADDRESS OF BANK
; A IS BANK
; COPY $1000 BYTES
CPY_TO_BUF:




WORKING_BUF:
	; DS	4096, 0
