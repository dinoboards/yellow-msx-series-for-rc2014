
; Code to write each memory segment onto the ROM banks

; then reboot!

; Erase a ROM SEGMENT!

PSL_STAT:       EQU     $A8             ; slot status

; ROM ERASE-SECTOR WRITE PROCEDURE:
; 1. WRITE TO 5555H AAH 
; 2. WRITE TO 02AAA 55H
; 3. WRITE TO 5555H 80H 
; 4. WRITE TO 5555H AAH 
; 5. WRITE TO 2AAAH 55H 
; 6. WRITE TO <sector> 30H 
	ORG	0C000H

	DI
LOOP:
	CALL	ERASE_SECTOR_0
	HALT

	PUBLIC	ERASE_SECTOR_0
ERASE_SECTOR_0:
	IN	A, (PSL_STAT)		; SELECT SLOT 0 FOR PAGE 0 AND PAGE 1
	AND	011110000B
	OUT	(PSL_STAT), A

	LD	A, 0AAH			; WRITES AA to 05555 (ROM)
	LD	(05555H), A

	LD	A, 055H			; WRITES 55 to 02AAA (ROM)
	LD	(02AAAH), A

	LD	A, 080H			; WRITES 80 to 05555 (ROM)
	LD	(05555H), A

	LD	A, 0AAH			; WRITES AA to 05555 (ROM)
	LD	(05555H), A

	LD	A, 055H			; WRITES 55 to 02AAA (ROM)
	LD	(02AAAH), A

	LD	A, 030H			; WRITE 30 TO 00000 (ROM)
	LD	(00000H), A

	; LD	A, 010H			; ERASE ROM
	; LD	(05555H), A

	RET

	PUBLIC	ERASE_SECTOR_127
ERASE_SECTOR_127:
	IN	A, (PSL_STAT)		; SELECT SLOT 0 FOR PAGE 0 AND PAGE 1
	AND	011110000B
	OUT	(PSL_STAT), A

	LD	A, 0AAH			; WRITES AA to 05555 (ROM)
	LD	(05555H), A

	LD	A, 055H			; WRITES 55 to 02AAA (ROM)
	LD	(02AAAH), A

	LD	A, 080H			; WRITES 80 to 05555 (ROM)
	LD	(05555H), A

	LD	A, 0AAH			; WRITES AA to 05555 (ROM)
	LD	(05555H), A

	LD	A, 055H			; WRITES 55 to 02AAA (ROM)
	LD	(02AAAH), A

	IN	A, (PSL_STAT)		; SELECT SLOT 3 FOR PAGE 1
	OR	000001100B
	OUT	(PSL_STAT), A

	LD	A, (0FFFFH)		; SELECT SUB SLOT 3 FOR PAGE 1
	CPL	
	OR	00000100B		; MASK IN 01 FOR PAGE 1
	AND	11111011B
	LD	(0FFFFH), A

	LD	A, 030H			; WRITE 30 TO FF000 (ROM)
	LD	(07000H), A

	RET

	PUBLIC	ERASE_SECTOR_126
ERASE_SECTOR_126:
	IN	A, (PSL_STAT)		; SELECT SLOT 0 FOR PAGE 0 AND PAGE 1
	AND	011110000B
	OUT	(PSL_STAT), A

	LD	A, 0AAH			; WRITES AA to 05555 (ROM)
	LD	(05555H), A

	LD	A, 055H			; WRITES 55 to 02AAA (ROM)
	LD	(02AAAH), A

	LD	A, 080H			; WRITES 80 to 05555 (ROM)
	LD	(05555H), A

	LD	A, 0AAH			; WRITES AA to 05555 (ROM)
	LD	(05555H), A

	LD	A, 055H			; WRITES 55 to 02AAA (ROM)
	LD	(02AAAH), A

	IN	A, (PSL_STAT)		; SELECT SLOT 3 FOR PAGE 1
	OR	000001100B
	OUT	(PSL_STAT), A

	LD	A, (0FFFFH)		; SELECT SUB SLOT 3 FOR PAGE 1
	CPL	
	OR	00000100B		; MASK IN 01 FOR PAGE 1
	AND	11111011B
	LD	(0FFFFH), A

	; 111 1111 xxxx xxxx xxxx
	LD	A, 030H			; WRITE 30 TO FE0000 (ROM)
	LD	(06000H), A

	RET
